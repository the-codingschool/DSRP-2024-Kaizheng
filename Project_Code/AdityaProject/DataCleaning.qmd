# Are accidents caused more by certain demographics? Gender, age, income}

# 

# Are accidents caused more by certain types of cars?

# 

# Are accidents happening more at certain times of the day? Divide day into 3 hr windows maybe

# 

# Are accidents happening more in certain areas of the streets? Intersections, freeways, regular portion of the streets? And what speed limit zones?

# 

# What % are caused due to speeding? Any other reason stands out?

# 

# How many cars on average ( daily /monthly/ annually ) get involved in accidents ( responsible or not )

# 

# Is there any trend where and what times - multiple car ( 3 or more cars ) accidents happen?

# 

# How many accidents are single car accidents? What are the main causes?

```{r}

#install.packages("readr")
library(readr)
library(dplyr)
library(janitor)

getwd()


#Step 1: Read the CSV file
traffic <- read.csv("Project_Code/Data/data_traffic.csv")


str(traffic)

```

```{r}
#Step 2: Visualizing some basic data

library(ggplot2)

ped <- filter(traffic, party_type == "Pedestrian")
count(ped, at_fault == "Yes")


#By month
ggplot(data = traffic, aes(x=month)) + geom_bar()


#By year
ggplot(data = traffic, aes(x=accident_year)) + geom_bar()


#By gender
pie(table(traffic$party_sex))


#Injury types
pie(table(traffic$collision_severity))


#Time of day

pie(table(traffic$time_cat))




```

```{r}
## This will only focus on who caused accidents

accidenters <- subset(traffic, at_fault == "Yes")

#head(accidenters)

accidenters

pie(table(accidenters$party_sex))

pie(table(accidenters$race))


count(accidenters, vz_pcf_description)

#by_age <- subset(accidenters, !is.na(party_age))
#by_age <- subset(by_age, party_age > 15)      

by_age <- filter(accidenters, party_age > 0)

#by_age

##Histogram by age and subdivided by gender
ggplot(data = by_age, aes(x=party_age, fill = factor(party_sex))) + geom_histogram()


```

```{r}


#Compares the types of vehicle
ggplot(traffic, aes(stwd_vehicle_type)) + geom_bar() + theme(axis.text.x = element_text(angle = 90))




primary_streets <- get_dupes(accidenters, primary_rd)
primary_streets 

secondary_streets <- get_dupes(accidenters, secondary_rd)
secondary_streets



important_street <- "MISSION ST"


acc_on_imp <- subset(accidenters, primary_rd == important_street)

acc_on_imp


ggplot(acc_on_imp, aes(vz_pcf_description)) + geom_bar()





count(acc_on_imp, vz_pcf_description)

#62 Driver or Bicyclist to yield right-of-way at crosswalks
#41 Following too closely prohibited
#31 illegal U turn in business district
#68 Red signal - driver or bicyclist responsibilities
#93 Unsafe speed for prevailing conditions
#73 unsafe turn or lange change prohibited
#43 Violation of right of way - left turn


count(acc_on_imp, distance == 0)

#354 incidents at intersection, 294 not at intersection

```

```{r}

#Step 1
people_demo <- select(traffic, c(party_type, at_fault, party_sex, party_age, party_sobriety, race))

str(people_demo)


#Cleaning party_age

#Get rid of negative ages


#Take car of NA values in party age (About 5000)
#Find the man and replace the NA with the mean

people_demo_positiveage <- filter(people_demo, party_age > 0)

mean_age <- as.integer(mean(people_demo_positiveage$party_age))

mean_age

people_demo$party_age <- replace(people_demo$party_age, is.na(people_demo$party_age), mean_age)

people_demo <- filter(people_demo, party_age > 0)





people_demo_changed <- people_demo

people_demo_changed



#Change gender from categorical to numerical

#people_demo_changed$party_sex <- replace(people_demo_changed$party_sex, people_demo_changed$party_sex == "Male", 1)
#people_demo_changed$party_sex <- replace(people_demo_changed$party_sex, people_demo_changed$party_sex == "Female", 2)
#people_demo_changed$party_sex <- replace(people_demo_changed$party_sex, people_demo_changed$party_sex == "Not Stated", 3)
#people_demo_changed$party_sex <- replace(people_demo_changed$party_sex, people_demo_changed$party_sex == "Other", 4)
#people_demo_changed$party_sex <- as.numeric(people_demo_changed$party_sex)

#Male - 1
#Female - 2
#Not stated - 3
#Other - 4


#One hot encoding
people_demo_changed <- people_demo_changed %>%
  
  mutate(Male = ifelse(party_sex == 'Male', 1, 0),
         Female = ifelse(party_sex == 'Female', 1, 0),
         Not_Stated_Gender = ifelse(party_sex == 'Not Stated', 1, 0),
         Other_Gender = ifelse(party_sex == 'Other', 1, 0))%>%
  
  select(-party_sex)

people_demo_changed




people_demo_changed$party_type <- replace(people_demo_changed$party_type, people_demo_changed$party_type == "Driver", 5)
people_demo_changed$party_type <- replace(people_demo_changed$party_type, people_demo_changed$party_type == "Bicyclist", 4)
people_demo_changed$party_type <- replace(people_demo_changed$party_type, people_demo_changed$party_type == "Pedestrian", 3)
people_demo_changed$party_type <- replace(people_demo_changed$party_type, people_demo_changed$party_type == "Other", 1)
people_demo_changed$party_type <- replace(people_demo_changed$party_type, people_demo_changed$party_type == "Parked Vehicle", 2)

people_demo_changed$party_type <- as.numeric(people_demo_changed$party_type)

#Driver - 5
#Bicyclist - 4
#Pedestrian - 3
#Parked Vehicle - 2
#Other - 1



people_demo_changed$party_sobriety <- replace(people_demo_changed$party_sobriety, people_demo_changed$party_sobriety == "Had Been Drinking, Impairment Unknown", 2)
people_demo_changed$party_sobriety <- replace(people_demo_changed$party_sobriety, people_demo_changed$party_sobriety == "Had Been Drinking, Not Under Influence", 3)
people_demo_changed$party_sobriety <- replace(people_demo_changed$party_sobriety, people_demo_changed$party_sobriety == "Had Been Drinking, Under Influence", 4)
people_demo_changed$party_sobriety <- replace(people_demo_changed$party_sobriety, people_demo_changed$party_sobriety == "Had Not Been Drinking", 1)
people_demo_changed$party_sobriety <- replace(people_demo_changed$party_sobriety, people_demo_changed$party_sobriety %in% c("Impairment Not Known", "Not Applicable", "Not Stated"), 0)

people_demo_changed$party_sobriety <- as.numeric(people_demo_changed$party_sobriety)


#Had Been Drinking, Impairment Unknown - 2
#Had Been Drinking, Not Under Influence	- 3
#Had Been Drinking, Under Influence	- 4
#Had Not Been Drinking - 1
#Impairment Not Known, Not Applicable, Not Stated	- 0




#people_demo_changed$race <- replace(people_demo_changed$race, people_demo_changed$race == "Asian", 1)
#people_demo_changed$race <- replace(people_demo_changed$race, people_demo_changed$race == "Black", 2)
#people_demo_changed$race <- replace(people_demo_changed$race, people_demo_changed$race == "Hispanic", 3)
#people_demo_changed$race <- replace(people_demo_changed$race, people_demo_changed$race == "White", 4)
#people_demo_changed$race <- replace(people_demo_changed$race, people_demo_changed$race %in% c("Other", "Not Stated"), 5)

#people_demo_changed$race <- as.numeric(people_demo_changed$race)

people_demo_changed <- people_demo_changed %>%
  # Create dummy variables for each race category
  mutate(Asian = ifelse(race == 'Asian', 1, 0),
         Black = ifelse(race == 'Black', 1, 0),
         Hispanic = ifelse(race == 'Hispanic', 1, 0),
         White = ifelse(race == 'White', 1, 0),
         Other_Race = ifelse(race == 'Other', 1, 0),
         Not_Stated_Race = ifelse(race == 'Not Stated', 1, 0)) %>%
  # Select the columns we want to keep, excluding race
  select(-race)

is.numeric(people_demo_changed$Asian)

people_demo_changed

#Asian - 1
#Black - 2
#Hispanic - 3
#White - 4
#Other, Not Stated - 5


people_demo_changed$at_fault <- replace(people_demo_changed$at_fault, people_demo_changed$at_fault == "No", 0)
people_demo_changed$at_fault <- replace(people_demo_changed$at_fault, people_demo_changed$at_fault == "Yes", 1)

people_demo_changed$at_fault <- as.numeric(people_demo_changed$at_fault)


#Yes - 1
#No - 0

#is.numeric(people_demo_changed$at_fault[0])

#people_demo_changed$at_fault[c("Yes", "No")] <- c(0, 1)






people_demo

str(people_demo_changed)

is.numeric(people_demo_changed$party_type)

is.numeric(people_demo_changed$Male)



```
```{r}
sig_accident_info <- select(traffic, c(collision_severity, type_of_collision, ped_action, road_surface, lighting, number_injured, party_type, party_sex, party_age, party_sobriety, race, at_fault))

str(sig_accident_info)


sig_accident_info$party_age <- replace(sig_accident_info$party_age, is.na(sig_accident_info$party_age), mean_age)
sig_accident_info <- filter(sig_accident_info, party_age > 0)


sig_accident_info <- sig_accident_info %>%
  
  mutate(Male = ifelse(party_sex == 'Male', 1, 0),
         Female = ifelse(party_sex == 'Female', 1, 0),
         Not_Stated_Gender = ifelse(party_sex == 'Not Stated', 1, 0),
         Other_Gender = ifelse(party_sex == 'Other', 1, 0))%>%
  
  select(-party_sex)

#Male - 1
#Female - 2
#Not stated - 3
#Other - 4


sig_accident_info$party_type <- replace(sig_accident_info$party_type, sig_accident_info$party_type == "Driver", 5)
sig_accident_info$party_type <- replace(sig_accident_info$party_type, sig_accident_info$party_type == "Bicyclist", 4)
sig_accident_info$party_type <- replace(sig_accident_info$party_type, sig_accident_info$party_type == "Pedestrian", 3)
sig_accident_info$party_type <- replace(sig_accident_info$party_type, sig_accident_info$party_type == "Other", 1)
sig_accident_info$party_type <- replace(sig_accident_info$party_type, sig_accident_info$party_type == "Parked Vehicle", 2)

sig_accident_info$party_type <- as.numeric(sig_accident_info$party_type)

#Driver - 5
#Bicyclist - 4
#Pedestrian - 3
#Parked Vehicle - 2
#Other - 1


sig_accident_info$party_sobriety <- replace(sig_accident_info$party_sobriety, sig_accident_info$party_sobriety == "Had Been Drinking, Impairment Unknown", 2)
sig_accident_info$party_sobriety <- replace(sig_accident_info$party_sobriety, sig_accident_info$party_sobriety == "Had Been Drinking, Not Under Influence", 3)
sig_accident_info$party_sobriety <- replace(sig_accident_info$party_sobriety, sig_accident_info$party_sobriety == "Had Been Drinking, Under Influence", 4)
sig_accident_info$party_sobriety <- replace(sig_accident_info$party_sobriety, sig_accident_info$party_sobriety == "Had Not Been Drinking", 1)
sig_accident_info$party_sobriety <- replace(sig_accident_info$party_sobriety, sig_accident_info$party_sobriety %in% c("Impairment Not Known", "Not Applicable", "Not Stated"), 0)

sig_accident_info$party_sobriety <- as.numeric(sig_accident_info$party_sobriety)


#Had Been Drinking, Impairment Unknown - 2
#Had Been Drinking, Not Under Influence	- 3
#Had Been Drinking, Under Influence	- 4
#Had Not Been Drinking - 1
#Impairment Not Known, Not Applicable, Not Stated	- 0


sig_accident_info <- sig_accident_info %>%
  # Create dummy variables for each race category
  mutate(Asian = ifelse(race == 'Asian', 1, 0),
         Black = ifelse(race == 'Black', 1, 0),
         Hispanic = ifelse(race == 'Hispanic', 1, 0),
         White = ifelse(race == 'White', 1, 0),
         Other_Race = ifelse(race == 'Other', 1, 0),
         Not_Stated_Race = ifelse(race == 'Not Stated', 1, 0)) %>%
  # Select the columns we want to keep, excluding race
  select(-race)

is.numeric(sig_accident_info$Asian)

#Asian - 1
#Black - 2
#Hispanic - 3
#White - 4
#Other, Not Stated - 5


sig_accident_info$at_fault <- replace(sig_accident_info$at_fault, sig_accident_info$at_fault == "No", 0)
sig_accident_info$at_fault <- replace(sig_accident_info$at_fault, sig_accident_info$at_fault == "Yes", 1)

sig_accident_info$at_fault <- as.numeric(sig_accident_info$at_fault)

#Yes - 1
#No - 0


sig_accident_info$collision_severity <- replace(sig_accident_info$collision_severity, sig_accident_info$collision_severity == "Medical", 1)
sig_accident_info$collision_severity <- replace(sig_accident_info$collision_severity, sig_accident_info$collision_severity == "Injury (Other Visible)", 2)
sig_accident_info$collision_severity <- replace(sig_accident_info$collision_severity, sig_accident_info$collision_severity == "Injury (Complaint of Pain)", 3)
sig_accident_info$collision_severity <- replace(sig_accident_info$collision_severity, sig_accident_info$collision_severity == "Injury (Severe)", 4)
sig_accident_info$collision_severity <- replace(sig_accident_info$collision_severity, sig_accident_info$collision_severity == "Fatal", 5)


sig_accident_info$collision_severity <- as.numeric(sig_accident_info$collision_severity)


#Medical - 1
#Injury (Other Visible) - 2
#Injury (Complaint of Pain) - 3
#Injury (Severe) - 4
#Fatal - 5

sig_accident_info <- sig_accident_info %>%
  mutate(Broadside = ifelse(type_of_collision == 'Broadside', 1, 0),
         Head_On = ifelse(type_of_collision == 'Head-On', 1, 0),
         Hit_Object = ifelse(type_of_collision == 'Hit_Object', 1, 0),
         Not_Stated_TypeCollision = ifelse(type_of_collision == 'Not Stated', 1, 0),
         Other_TypeCollision = ifelse(type_of_collision == 'Other', 1, 0),
         Overturned = ifelse(type_of_collision == 'Overturned', 1, 0),
         Rear_End = ifelse(type_of_collision == 'Rear End', 1, 0),
         Sideswipe = ifelse(type_of_collision == 'Sideswipe', 1, 0),
         Vehicle_Ped = ifelse(type_of_collision == 'Vehicle/Pedestrian', 1, 0)) %>%
  select(-type_of_collision)



sig_accident_info$road_surface <- replace(sig_accident_info$road_surface, sig_accident_info$road_surface == "Not Stated", 1)
sig_accident_info$road_surface <- replace(sig_accident_info$road_surface, sig_accident_info$road_surface == "Dry", 2)
sig_accident_info$road_surface <- replace(sig_accident_info$road_surface, sig_accident_info$road_surface == "Slippery", 3)
sig_accident_info$road_surface <- replace(sig_accident_info$road_surface, sig_accident_info$road_surface == "Wet", 4)
sig_accident_info$road_surface <- replace(sig_accident_info$road_surface, sig_accident_info$road_surface == "Snowy or Icy", 5)

sig_accident_info$road_surface <- as.numeric(sig_accident_info$road_surface)


#Not Stated - 1
#Dry - 2
#Slippery - 3
#Wet - 4
#Snowy or Icy - 5


sig_accident_info$lighting <- replace(sig_accident_info$lighting, sig_accident_info$lighting == "Not Stated", 1)
sig_accident_info$lighting <- replace(sig_accident_info$lighting, sig_accident_info$lighting == "Daylight", 2)
sig_accident_info$lighting <- replace(sig_accident_info$lighting, sig_accident_info$lighting == "Dusk - Dawn", 3)
sig_accident_info$lighting <- replace(sig_accident_info$lighting, sig_accident_info$lighting == "Dark - Street Lights", 4)
sig_accident_info$lighting <- replace(sig_accident_info$lighting, sig_accident_info$lighting %in% c("Dark - No Street Lights", "Dark - Street Lights Not Functioning	"), 5)

sig_accident_info$lighting <- as.numeric(sig_accident_info$lighting)

#Not Stated - 1
#Daylight - 2
#Dusk - Dawn - 3
#Dark - Street Lights - 4
#Dark - No Street Lights or Not Functioning - 5

sig_accident_info <- sig_accident_info %>%
  mutate(Walking_From_SchoolBus = ifelse(ped_action == 'Approaching/Leaving School Bus', 1, 0),
         Crossing_NI_CW = ifelse(ped_action == 'Crossing Not in Crosswalk', 1, 0),
         Not_Stated_TypeCollision = ifelse(ped_action == 'Not Stated', 1, 0),
         Crossing_CW_NINT = ifelse(ped_action == 'Crossing in Crosswalk Not at Intersection', 1, 0),
         Crossing_CW_INT = ifelse(ped_action == 'Crossing in Crosswalk at Intersection', 1, 0),
         In_Road_Shoulder = ifelse(ped_action == 'In Road, Including Shoulder', 1, 0),
         No_Pedestrian = ifelse(ped_action == 'No Pedestrian Involved', 1, 0),
         Not_In_Road = ifelse(ped_action == 'Not in Road', 1, 0)) %>%
  select(-ped_action)







str(sig_accident_info)






```

